---
title: "CI/CDã®CDã£ã¦ãªã‚“ã§CIã«å«ã¾ã‚Œãªã„ã®ï¼Ÿã¨ã„ã†ç–‘å•ã‚’æŒã£ãŸã‚ãªãŸã«ã“ãè§¦ã£ã¦ã»ã—ã„Argo CD"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

## 0. ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ã€‚éƒ½å†…ã§ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹ã€[@gkzvoice](https://twitter.com/gkzvoice)ã§ã™ã€‚ã“ã“åŠå¹´ã»ã©CI/CDç’°å¢ƒæ§‹ç¯‰ã«æºã‚ã£ã¦ã„ã¾ã™ãŒã€å½“åˆã¯ã“ã®ã‚ˆã†ãªç–‘å•ã‚’æŠ±ãˆã¦ã„ã¾ã—ãŸã€‚

```
CI/CDã®CDã£ã¦ãªã‚“ã§CIã«å«ã¾ã‚Œãªã„ã®ï¼Ÿ
```
ã‚°ã‚°ã£ã¦ã‚‚è¾æ›¸çš„ãªæ„å‘³ã—ã‹è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãã“ã§æ–‡å­—é€šã‚Šè©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰CI/CDç’°å¢ƒã‚’ä½œã£ã¦ã¯å£Šã—ã¦ç¹°ã‚Šè¿”ã—ã¦ã€ä¸Šè¨˜ã®ç–‘å•ã«å¯¾ã™ã‚‹è‡ªåˆ†ã®è€ƒãˆã¯ã˜ã‚ã€ã„ãã¤ã‹ã®ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸã€‚ãã“ã§ãã‚Œã‚‰ã‚’å¿˜ã‚Œãªã„ã†ã¡ã«æ›¸ãæ®‹ãã†ã¨æ€ã„ã¾ã™ã€‚


### ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™

https://twitter.com/gkzvoice/status/1362733588316233735


## 1. ç›®æ¬¡

```
- 2. CI/CDã®CDã£ã¦ãªã‚“ã§CIã«å«ã¾ã‚Œãªã„ã®ï¼Ÿ
- 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’åˆ‡ã‚Šå‡ºã—ã¦åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã™ã‚‹æ„ç¾©ã¨èª²é¡Œ
- 4. ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸IDã«gitã®ã‚³ãƒŸãƒƒãƒˆã®ãƒãƒƒã‚·ãƒ¥ã‚’æ¡ç”¨ã—ãŸ
- 5. ãƒ‡ãƒ¢CI/CDç’°å¢ƒ
- 6. ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®è§£èª¬
- 7. èª²é¡Œã¨ã—ã¦æ®‹ã£ãŸãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®è‡ªå‹•åŒ–
```

## 2. CI/CDã®CDã£ã¦ãªã‚“ã§CIã«å«ã¾ã‚Œãªã„ã®ï¼Ÿ

```
ãƒ“ãƒ«ãƒ‰=ãƒ‡ãƒ—ãƒ­ã‚¤@ç’°å¢ƒA
â†“
ãƒ†ã‚¹ãƒˆ@ç’°å¢ƒA
```
ãƒ†ã‚¹ãƒˆãŒã‚³ã‚±ãŸã‚‰ã€ã€ã€

```
ãƒ“ãƒ«ãƒ‰@ç’°å¢ƒA
â†“
ãƒ†ã‚¹ãƒˆ@ç’°å¢ƒA
â†“
ãƒ‡ãƒ—ãƒ­ã‚¤@ç’°å¢ƒB
```
ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ãƒ†ã‚¹ãƒˆãŒé€šéã—ã¦ã„ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹

## 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’åˆ‡ã‚Šå‡ºã—ã¦åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã™ã‚‹æ„ç¾©ã¨èª²é¡Œ

https://speakerdeck.com/masayaaoyama/cndt2020-k8s-amsy810?slide=11

è²¬ä»»å…±æœ‰ãƒ¢ãƒ‡ãƒ«

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«å°‚å¿µå‡ºæ¥ã‚‹
 

### 3-x. ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã®æ›´æ–°ã‚’ã©ã†åæ˜ ã•ã›ã‚‹ã‹

- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚§ãƒ¼ã‚ºã‚’è‡ªå‹•åŒ–ã™ã‚‹éš›ã«ãƒãƒƒã‚¯ã¨ãªã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ID
  - timestampã¨ãƒ¦ãƒ‹ãƒ¼ã‚¯æ€§ã€æ™‚é–“ã®æ¦‚å¿µ

## 4. ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸IDã«gitã®ã‚³ãƒŸãƒƒãƒˆã®ãƒãƒƒã‚·ãƒ¥ã‚’æ¡ç”¨ã—ãŸ

- cf. [gitã§æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—ã™ã‚‹ (rev-parse) - ã„ã‚ã„ã‚å‚™å¿˜éŒ²æ—¥è¨˜](https://devlights.hatenablog.com/entry/2020/12/16/165245)
- cf. [gitã§ç‰¹å®šã®commitãƒãƒ¼ã‚¸ãƒ§ãƒ³/ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã‚’æŒ‡ã™ã‚¢ãƒ¬ã‚’ãªã‚“ã¨å‘¼ã¶ã‹å•é¡Œ - Qiita](https://qiita.com/bigwheel/items/0b331451558637ee29b3)


## 5. ãƒ‡ãƒ¢CI/CDç’°å¢ƒ

draw.ioã§æ§‹æˆå›³ã‚’ãŠçµµæãã—ã¾ã™ã€‚

```
Appãƒªãƒã‚¸ãƒˆãƒªæ›´æ–° --------> Gitlab RunnerãŒbuild/test ------> testãŒé€šã£ãŸã‚‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’git cloneã—ã¦æ›´æ–°

â†“
â†“

Argo CDãŒãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ã‚’å–ã‚Šè¾¼ã‚€

```

## 6. ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®è§£èª¬

CIã¯Gitlab RunnerãŒå®Ÿè¡Œã—ã€CIãŒå®Œäº†ã—ãŸã‚‰Argo CDãŒãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

- ã‚³ãƒ³ãƒ†ãƒŠã‚’build -> run -> test -> ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«push
  - Dockerã‚³ãƒãƒ³ãƒ‰ã¯Makefileã«å¯„ã›ã¦ã„ã‚‹
```
before_script:
  - COMMIT_HASH=$(git rev-parse --short HEAD)
  ç•¥
script:
 - make build
 - make run
 - make coverage

 ç•¥(coverageã®çµæœã‚’é‘‘ã¿ã¦å¾Œç¶šã®å‡¦ç†ã‚’ç¶šã‘ã‚‹ã‹åˆ¤å®šãŒå¿…è¦ã€‚ã“ã“ã§ã¯å‰²æ„›)

 - make push
 - ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’git clone
 - ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã¨ãªã‚‹demoãƒ–ãƒ©ãƒ³ãƒã«checkout
 - yqã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸IDã‚’æ›´æ–°
 - git add deployment.yml
 - 'git commit -m "RUNNER: ${COMMIT_HASH}" deployment.yml'
 - git push -fu origin demo
```

## 7. èª²é¡Œã¨ã—ã¦æ®‹ã£ãŸãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®è‡ªå‹•åŒ–